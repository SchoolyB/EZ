name: CI

on:
  push:
    branches:
      - main
      - release
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Build interpreter
        run: go build -o ez ./cmd/ez
        if: runner.os != 'Windows'

      - name: Build interpreter (Windows)
        run: go build -o ez.exe ./cmd/ez
        if: runner.os == 'Windows'

      - name: Run interpreter tests
        if: runner.os != 'Windows'
        run: ./ez run tests/comprehensive.ez

      - name: Run interpreter tests (Windows)
        if: runner.os == 'Windows'
        run: .\ez.exe run tests\comprehensive.ez

      - name: Validate example files
        if: runner.os != 'Windows'
        run: |
          for file in examples/*.ez; do
            echo "Validating $file..."
            ./ez build "$file" || exit 1
          done

      - name: Validate example files (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-ChildItem examples\*.ez | ForEach-Object {
            Write-Host "Validating $_..."
            & .\ez.exe build $_.FullName
            if ($LASTEXITCODE -ne 0) { exit 1 }
          }

      - name: Test REPL basic functionality (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Testing REPL..."
          echo -e "temp x int = 5\nx + 10\nexit" | timeout 5 ./ez repl | grep -q "15"

      - name: Test REPL basic functionality (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Testing REPL..."
          # macOS doesn't have timeout, use a subshell with background process
          (echo -e "temp x int = 5\nx + 10\nexit" | ./ez repl > /tmp/repl_output.txt) &
          pid=$!
          sleep 5
          kill $pid 2>/dev/null || true
          grep -q "15" /tmp/repl_output.txt

      - name: Test REPL basic functionality (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Testing REPL..."
          "temp x int = 5", "x + 10", "exit" | & .\ez.exe repl
