name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: go
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json
          # Customize the changelog sections
          changelog-types: >
            [
              {"type": "feat", "section": "Features", "hidden": false},
              {"type": "fix", "section": "Bug Fixes", "hidden": false},
              {"type": "perf", "section": "Performance Improvements", "hidden": false},
              {"type": "revert", "section": "Reverts", "hidden": false},
              {"type": "docs", "section": "Documentation", "hidden": false},
              {"type": "chore", "section": "Miscellaneous", "hidden": true},
              {"type": "style", "section": "Styles", "hidden": true},
              {"type": "refactor", "section": "Code Refactoring", "hidden": true},
              {"type": "test", "section": "Tests", "hidden": true},
              {"type": "build", "section": "Build System", "hidden": true},
              {"type": "ci", "section": "CI", "hidden": true}
            ]

  # Smart auto-merge: only auto-merge release PRs with user-facing changes
  auto-merge-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.pr }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if PR should auto-merge
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ fromJson(needs.release-please.outputs.pr).number }}
        run: |
          echo "Checking release PR #$PR_NUMBER for auto-merge eligibility..."

          # Get PR body (contains changelog)
          PR_BODY=$(gh pr view "$PR_NUMBER" --json body --jq '.body')

          SHOULD_RELEASE=false

          # Check changelog sections for user-facing changes
          # These are generated from conventional commit prefixes:
          # feat:, fix:, perf:, revert:, hotfix:, bugfix:, patch:, feature:
          if echo "$PR_BODY" | grep -qE "^### (Features|Bug Fixes|Performance Improvements|Reverts)"; then
            echo "Found user-facing changes in changelog (Features/Bug Fixes/Perf/Reverts)"
            SHOULD_RELEASE=true
          fi

          # Also check for commit prefixes directly in the PR body
          # This catches non-standard prefixes that might be included
          if [ "$SHOULD_RELEASE" = "false" ]; then
            if echo "$PR_BODY" | grep -qiE "\* (feat|fix|hotfix|bugfix|patch|feature|perf|revert)(\(.+\))?:"; then
              echo "Found release-worthy commit prefix in changelog"
              SHOULD_RELEASE=true
            fi
          fi

          if [ "$SHOULD_RELEASE" = "true" ]; then
            echo "should_merge=true" >> $GITHUB_OUTPUT
            echo "✅ PR qualifies for auto-merge"
          else
            echo "should_merge=false" >> $GITHUB_OUTPUT
            echo "⏸️ PR contains only internal changes (chore/docs/refactor/etc), skipping auto-merge"
            echo "   Release PR will stay open until a feat/fix/hotfix commit is added"
          fi

      - name: Enable auto-merge
        if: steps.check.outputs.should_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT }}
          PR_NUMBER: ${{ fromJson(needs.release-please.outputs.pr).number }}
        run: |
          echo "Enabling auto-merge for PR #$PR_NUMBER..."
          gh pr merge "$PR_NUMBER" --auto --squash
          echo "✅ Auto-merge enabled - PR will merge when CI passes"

  build-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build release binaries
        run: make release VERSION=${{ needs.release-please.outputs.tag_name }}

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          gh release upload $TAG_NAME \
            dist/ez-darwin-amd64.tar.gz \
            dist/ez-darwin-arm64.tar.gz \
            dist/ez-linux-amd64.tar.gz \
            dist/ez-linux-arm64.tar.gz \
            dist/ez-windows-amd64.zip \
            dist/checksums.txt

  # Update playground WASM in website repo
  update-playground:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout EZ repo
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build WASM
        run: |
          echo "Building EZ WASM..."
          GOOS=js GOARCH=wasm go build -o cmd/wasm/ez.wasm ./cmd/wasm
          echo "WASM build complete"

      - name: Checkout website repo
        uses: actions/checkout@v4
        with:
          repository: SchoolyB/language.ez
          token: ${{ secrets.RELEASE_PAT }}
          path: website

      - name: Update WASM files
        run: |
          mkdir -p website/public/wasm
          cp cmd/wasm/ez.wasm website/public/wasm/
          cp cmd/wasm/wasm_exec.js website/public/wasm/

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          cd website
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="update-wasm-${TAG_NAME}"
          git checkout -b "$BRANCH"
          git add public/wasm/
          git commit -m "chore: update playground WASM to ${TAG_NAME}"
          git push origin "$BRANCH"

          gh pr create \
            --title "chore: update playground WASM to ${TAG_NAME}" \
            --body "Automated PR to update the playground WASM binary to EZ ${TAG_NAME}." \
            --base main \
            --head "$BRANCH"
