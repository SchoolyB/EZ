/*
 * const_ref.ez - Test const ref creates read-only view
 *
 * Tests that:
 * - temp ref allows modification (existing behavior)
 * - const ref can read the value
 * - const ref sees changes made to original
 * - & parameters work correctly (always mutable)
 */

import @std, @arrays
using std

const Point struct {
    x int
    y int
}

do modify_array(&arr [int]) {
    arrays.append(arr, 999)
}

do modify_struct(&p Point) {
    p.x = 999
}

do main() {
    println("=== Const Ref Tests ===")
    temp passed int = 0
    temp failed int = 0

    // Test 1: temp ref allows modification
    temp arr1 [int] = {1, 2, 3}
    temp r1 = ref(arr1)
    arrays.append(r1, 4)
    if len(arr1) == 4 && arr1[3] == 4 {
        println("  [PASS] temp ref allows modification")
        passed += 1
    } otherwise {
        println("  [FAIL] temp ref should allow modification")
        failed += 1
    }

    // Test 2: const ref can read value
    temp arr2 [int] = {10, 20, 30}
    const r2 = ref(arr2)
    if r2[0] == 10 && r2[1] == 20 && r2[2] == 30 {
        println("  [PASS] const ref can read value")
        passed += 1
    } otherwise {
        println("  [FAIL] const ref should be readable")
        failed += 1
    }

    // Test 3: const ref sees changes to original
    temp arr3 [int] = {1, 2, 3}
    const r3 = ref(arr3)
    arrays.append(arr3, 4)  // Modify original directly
    if len(r3) == 4 && r3[3] == 4 {
        println("  [PASS] const ref sees changes to original")
        passed += 1
    } otherwise {
        println("  [FAIL] const ref should see original changes")
        failed += 1
    }

    // Test 4: & parameter works (always mutable)
    temp arr4 [int] = {1, 2, 3}
    modify_array(arr4)
    if len(arr4) == 4 && arr4[3] == 999 {
        println("  [PASS] & parameter allows modification")
        passed += 1
    } otherwise {
        println("  [FAIL] & parameter should allow modification")
        failed += 1
    }

    // Test 5: & parameter with struct
    temp p1 = Point{x: 10, y: 20}
    modify_struct(p1)
    if p1.x == 999 {
        println("  [PASS] & parameter works with struct")
        passed += 1
    } otherwise {
        println("  [FAIL] & parameter should work with struct")
        failed += 1
    }

    // Test 6: temp ref to struct allows modification
    temp p2 = Point{x: 1, y: 2}
    temp rp = ref(p2)
    rp.x = 100
    if p2.x == 100 {
        println("  [PASS] temp ref to struct allows modification")
        passed += 1
    } otherwise {
        println("  [FAIL] temp ref to struct should allow modification")
        failed += 1
    }

    // Summary
    println("")
    println("Results: ${passed} passed, ${failed} failed")
    if failed > 0 {
        println("SOME TESTS FAILED")
    } otherwise {
        println("ALL TESTS PASSED")
    }
}
