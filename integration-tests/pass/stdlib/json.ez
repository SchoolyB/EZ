/*
 * json.ez - Test @json standard library with PROPER ASSERTIONS
 */

import @std, @json
using std

// Struct definitions for typed decode tests
const Person struct {
    name string
    age int
}

const Task struct {
    title string
    completed bool
}

const Address struct {
    street string
    city string
}

do main() {
    println("=== @json Standard Library Test ===")
    temp passed int = 0
    temp failed int = 0

    // ==================== json.encode ====================
    println("  -- json.encode --")

    // Test 1: encode string
    temp str_result string, str_err Error = json.encode("hello")
    if str_err == nil {
        if str_result == "\"hello\"" {
            println("  [PASS] json.encode(string)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(string): expected '\"hello\"', got '${str_result}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(string): unexpected error")
        failed += 1
    }

    // Test 2: encode integer
    temp int_result string, int_err Error = json.encode(42)
    if int_err == nil {
        if int_result == "42" {
            println("  [PASS] json.encode(int)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(int): expected '42', got '${int_result}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(int): unexpected error")
        failed += 1
    }

    // Test 3: encode float
    temp float_result string, float_err Error = json.encode(3.14)
    if float_err == nil {
        if float_result == "3.14" {
            println("  [PASS] json.encode(float)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(float): expected '3.14', got '${float_result}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(float): unexpected error")
        failed += 1
    }

    // Test 4: encode boolean true
    temp true_result string, true_err Error = json.encode(true)
    if true_err == nil {
        if true_result == "true" {
            println("  [PASS] json.encode(true)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(true): expected 'true', got '${true_result}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(true): unexpected error")
        failed += 1
    }

    // Test 5: encode boolean false
    temp false_result string, false_err Error = json.encode(false)
    if false_err == nil {
        if false_result == "false" {
            println("  [PASS] json.encode(false)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(false): expected 'false', got '${false_result}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(false): unexpected error")
        failed += 1
    }

    // Test 6: encode nil
    temp nil_result string, nil_err Error = json.encode(nil)
    if nil_err == nil {
        if nil_result == "null" {
            println("  [PASS] json.encode(nil)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(nil): expected 'null', got '${nil_result}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(nil): unexpected error")
        failed += 1
    }

    // Test 7: encode array
    temp arr [int] = {1, 2, 3}
    temp arr_result string, arr_err Error = json.encode(arr)
    if arr_err == nil {
        if arr_result == "[1,2,3]" {
            println("  [PASS] json.encode(array)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(array): expected '[1,2,3]', got '${arr_result}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(array): unexpected error")
        failed += 1
    }

    // Test 8: encode struct
    temp person Person = Person{name: "Alice", age: 30}
    temp person_json string, person_json_err Error = json.encode(person)
    if person_json_err == nil {
        // JSON keys are sorted alphabetically
        if person_json == "{\"age\":30,\"name\":\"Alice\"}" {
            println("  [PASS] json.encode(struct)")
            passed += 1
        } otherwise {
            println("  [FAIL] json.encode(struct): got '${person_json}'")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.encode(struct): unexpected error")
        failed += 1
    }

    // ==================== json.decode (typed) ====================
    println("  -- json.decode (typed) --")

    // Test 9: decode to typed struct
    temp decoded_person Person, person_err Error = json.decode("{\"name\": \"Alice\", \"age\": 30}", Person)
    if person_err == nil {
        if decoded_person.name == "Alice" {
            if decoded_person.age == 30 {
                println("  [PASS] json.decode(string, Person)")
                passed += 1
            } otherwise {
                println("  [FAIL] json.decode(typed): age mismatch")
                failed += 1
            }
        } otherwise {
            println("  [FAIL] json.decode(typed): name mismatch")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.decode(typed): unexpected error")
        failed += 1
    }

    // Test 10: decode typed struct with missing field (should use zero value)
    temp person2 Person, person2_err Error = json.decode("{\"name\": \"Bob\"}", Person)
    if person2_err == nil {
        if person2.age == 0 {
            println("  [PASS] json.decode(typed) missing field uses zero value")
            passed += 1
        } otherwise {
            println("  [FAIL] json.decode(typed): missing field should be 0")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.decode(typed) missing field: unexpected error")
        failed += 1
    }

    // Test 11: decode typed struct with bool field
    temp task Task, task_err Error = json.decode("{\"title\": \"Test\", \"completed\": true}", Task)
    if task_err == nil {
        if task.completed == true {
            println("  [PASS] json.decode(typed) with bool field")
            passed += 1
        } otherwise {
            println("  [FAIL] json.decode(typed): bool field mismatch")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.decode(typed) bool field: unexpected error")
        failed += 1
    }

    // Test 12: decode invalid JSON returns error
    temp invalid_person Person, invalid_err Error = json.decode("{invalid}", Person)
    if invalid_err != nil {
        println("  [PASS] json.decode(invalid) returns error")
        passed += 1
    } otherwise {
        println("  [FAIL] json.decode(invalid): expected error")
        failed += 1
    }

    // Test 13: decode with extra fields (should be ignored)
    temp extra_person Person, extra_err Error = json.decode("{\"name\": \"Charlie\", \"age\": 25, \"extra\": \"ignored\"}", Person)
    if extra_err == nil {
        if extra_person.name == "Charlie" && extra_person.age == 25 {
            println("  [PASS] json.decode(typed) ignores extra fields")
            passed += 1
        } otherwise {
            println("  [FAIL] json.decode(typed): field values incorrect")
            failed += 1
        }
    } otherwise {
        println("  [FAIL] json.decode(typed) extra fields: unexpected error")
        failed += 1
    }

    // ==================== json.is_valid ====================
    println("  -- json.is_valid --")

    // Test 14: valid JSON string
    if json.is_valid("\"hello\"") {
        println("  [PASS] json.is_valid(string)")
        passed += 1
    } otherwise {
        println("  [FAIL] json.is_valid(string): expected true")
        failed += 1
    }

    // Test 15: valid JSON object
    if json.is_valid("{\"key\": \"value\"}") {
        println("  [PASS] json.is_valid(object)")
        passed += 1
    } otherwise {
        println("  [FAIL] json.is_valid(object): expected true")
        failed += 1
    }

    // Test 16: valid JSON array
    if json.is_valid("[1, 2, 3]") {
        println("  [PASS] json.is_valid(array)")
        passed += 1
    } otherwise {
        println("  [FAIL] json.is_valid(array): expected true")
        failed += 1
    }

    // Test 17: invalid JSON
    if json.is_valid("{invalid}") == false {
        println("  [PASS] json.is_valid(invalid) returns false")
        passed += 1
    } otherwise {
        println("  [FAIL] json.is_valid(invalid): expected false")
        failed += 1
    }

    // ==================== json.pretty ====================
    println("  -- json.pretty --")

    // Test 18: pretty print array
    temp pretty_arr string, pretty_arr_err Error = json.pretty({1, 2}, "  ")
    if pretty_arr_err == nil {
        println("  [PASS] json.pretty(array)")
        passed += 1
    } otherwise {
        println("  [FAIL] json.pretty(array): unexpected error")
        failed += 1
    }

    // ==================== Summary ====================
    println("")
    println("=== Summary ===")
    println("  Passed: ${passed}")
    println("  Failed: ${failed}")
    println("")

    if failed > 0 {
        println("SOME TESTS FAILED")
    } otherwise {
        println("ALL TESTS PASSED")
    }
}
